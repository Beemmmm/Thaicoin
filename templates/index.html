<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>YOLOv5 Coin Detection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      body { font-family: 'Prompt', sans-serif; }
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .glass-effect {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .coin-icon {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-lg mx-auto glass-effect rounded-3xl shadow-2xl p-8">
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="coin-icon w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
        <i class="fas fa-coins text-white text-2xl"></i>
      </div>
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">ตรวจจับเหรียญไทย</h1>
      <p class="text-gray-600 text-lg">AI ช่วยนับเหรียญและคำนวณมูลค่า</p>
    </div>

    <!-- Upload Form -->
    <form id="uploadForm" class="space-y-6">
      <div class="relative">
        <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-blue-400 transition-colors">
          <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
          <p class="text-gray-600 mb-2">เลือกไฟล์รูปภาพเหรียญ</p>
          <input type="file" id="imageInput" name="image" accept="image/*" required 
                 class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
        </div>
      </div>
      
      <button type="submit" class="w-full py-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold rounded-xl shadow-lg transform hover:scale-105 transition-all duration-200 flex items-center justify-center gap-2">
        <i class="fas fa-search"></i>
        เริ่มตรวจจับ
      </button>
    </form>

    <!-- Loading -->
    <div id="loading" class="flex items-center justify-center mt-8 text-blue-600 text-lg font-medium" style="display:none;">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
      กำลังประมวลผล...
    </div>

    <!-- Results -->
    <div class="mt-8">
      <div class="flex justify-center">
        <img id="result-img" class="rounded-2xl shadow-xl max-h-80 w-auto" style="display:none" />
      </div>
      <div id="result-info" class="mt-6" style="display:none"></div>
    </div>
  </div>

  <script>
    const form = document.getElementById('uploadForm');
    const imageInput = document.getElementById('imageInput');
    const resultImg = document.getElementById('result-img');
    const loading = document.getElementById('loading');
    const resultInfo = document.getElementById('result-info');

    // File input preview
    imageInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          // You can add a preview here if needed
        };
        reader.readAsDataURL(file);
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      resultImg.style.display = 'none';
      resultInfo.style.display = 'none';
      loading.style.display = 'flex';

      const file = imageInput.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('image', file);

      try {
        const res = await fetch('/detect-coin-image', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        if (data.image) {
          resultImg.src = 'data:image/jpeg;base64,' + data.image;
          resultImg.style.display = 'block';
          
          // แสดง breakdown และยอดรวม
          let html = '';
          if (data.breakdown && data.breakdown.length > 0) {
            html += '<div class="bg-white rounded-2xl shadow-lg p-6">';
            html += '<h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fas fa-list-ul text-blue-600"></i>ผลการตรวจจับ</h3>';
            html += '<div class="space-y-3">';
            
            const sortedBreakdown = data.breakdown.sort((a, b) => (b.value || 0) - (a.value || 0));
            for (const coin of sortedBreakdown) {
              if (coin.count > 0) {
                const coinName = coin.name || `${coin.value} บาท`;
                const coinValue = coin.value || 0;
                const totalCoinValue = coinValue * coin.count;
                
                html += `
                  <div class="flex items-center justify-between p-4 bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl border border-gray-100">
                    <div class="flex items-center gap-3">
                      <div class="coin-icon w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm">
                        ${coin.value ?? '-'}
                      </div>
                      <div>
                        <div class="font-semibold text-gray-800">${coinName}</div>
                        <div class="text-sm text-gray-500">${coin.count} เหรียญ</div>
                      </div>
                    </div>
                    <div class="text-right">
                      <div class="font-bold text-lg text-blue-600">${totalCoinValue}</div>
                      <div class="text-xs text-gray-500">บาท</div>
                    </div>
                  </div>
                `;
              }
            }
            html += '</div>';
            
            if (data.total_value !== undefined && data.total_value > 0) {
              html += `<div class="mt-6 p-4 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl text-white text-center">
                <div class="text-2xl font-bold">${data.total_value} บาท</div>
                <div class="text-blue-100">มูลค่ารวม</div>
              </div>`;
            }
            
            if (data.total_coins !== undefined) {
              html += `<div class="mt-3 text-center text-gray-600">
                <i class="fas fa-coins mr-2"></i>เหรียญทั้งหมด: ${data.total_coins} เหรียญ
              </div>`;
            }
            
            html += '</div>';
          }
          
          resultInfo.innerHTML = html;
          resultInfo.style.display = 'block';
        } else {
          alert('เกิดข้อผิดพลาด: ' + (data.error || 'ไม่สามารถประมวลผลภาพได้'));
        }
      } catch (err) {
        alert('เกิดข้อผิดพลาด: ' + err);
      }
      loading.style.display = 'none';
    });
  </script>
</body>
</html>